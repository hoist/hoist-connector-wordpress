{"version":3,"sources":["poll.js"],"names":[],"mappings":"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","file":"poll.js","sourcesContent":["import WordpressConnector from './connector';\nimport logger from '@hoist/logger';\nimport Moment from 'moment'\nimport errors from '@hoist/errors';\nimport config from 'config';\n\nvar ConnectorRequiresAuthorizationError = errors.create({\n  name: 'ConnectorRequiresAuthorizationError'\n});\n\nclass WordpressPoller {\n  constructor(context) {\n    this._logger = logger.child({\n      cls: this.constructor.name,\n      subscription: context.subscription._id,\n      application: context.application._id\n    });\n    this._context = context;\n    this._connector = new WordpressConnector(context.settings);\n  }\n  poll() {\n    return this.assertCanPoll()\n      .then((hooksSetup) => {\n        if (!hooksSetup) {\n          return this.setupHook();\n        }\n      }).catch((err) => {\n        this._logger.error(err);\n        if (!(err instanceof ConnectorRequiresAuthorizationError)) {\n          this._logger.alert(err);\n        }\n      });\n  }\n  assertCanPoll() {\n    var hooksSetup = this._context.subscription.get('setup');\n    return Promise.resolve()\n      .then(() => {\n        if (hooksSetup) {\n          //we've already setup this subscription\n          this._context.subscription.delayTill(new Moment().add(100, 'days').toDate());\n        }\n      })\n      .then(() => {\n        this._logger.info('checking credentials');\n        if (!(this._context.authorization)) {\n          this._logger.warn('Connector needs auth and no auth set');\n          //we've already setup this subscription\n          this._context.subscription.delayTill(new Moment().add(1, 'hour').toDate());\n          throw new ConnectorRequiresAuthorizationError();\n        }\n        if (!this._context.authorization.get('SubscriptionProject')) {\n          this._logger.warn('Connector needs a subscription project and none set');\n          //we've already setup this subscription\n          this._context.subscription.delayTill(new Moment().add(1, 'hour').toDate());\n          throw new ConnectorRequiresAuthorizationError();\n        }\n      }).then(() => {\n        return hooksSetup;\n      });\n  }\n  setupHook() {\n    return Promise.resolve()\n      .then(() => {\n        this._logger.info('setting connector authorization');\n        return this._connector.authorize(this._context.authorization);\n      }).then(() => {\n        this._logger.info('creating webhook endpoint');\n        let hookUri = `https://${config.get('Hoist.domains.endpoint')}/connector/${this._context.authorization._token.key}`;\n        this._connector.post(`/projects/${this._context.authorization.get('SubscriptionProject')}/hooks`, {\n          \"url\":hookUri,\n          \"push_events\": true,\n          \"issues_events\": true,\n          \"merge_requests_events\": true,\n          \"tag_push_events\": true,\n          \"note_events\": true,\n          \"build_events\": true\n        });\n      }).then(() => {\n        this._logger.info('webhooks created');\n        return this._context.subscription.set('setup', true);\n      });\n  }\n}\n\nexport default function (context) {\n  let poller = new WordpressPoller(context);\n  return poller.poll();\n};\n"],"sourceRoot":"/source/"}